#!/bin/bash
set -e
# update-mirrors
#
# This script assumes you have paths in your $HOME that are
# git repos (which are mirrors).
#
# It will fetch from origin and push the changes to the mirror.

update_mirrors() {
	# find all the dirs in $HOME
	for dir in $(find $HOME -maxdepth 1 -type d -not -path '*/\.*' -not -path "$HOME"); do
		# subshell because we cd
		(
		cd $dir

		# check the git remote
		local ismirror=$(git config --get remote.origin.mirror 2>/dev/null)
		if [[ "$ismirror" == "true" ]]; then
			echo "$(basename $dir) is a git mirror"

			# fetch and push
			git fetch -p origin
			git push --mirror

			echo "Updated $(git config --get remote.origin.url) to $(git config --get remote.origin.pushurl)"
		fi
		)
	done
}

update_mirrors $@
